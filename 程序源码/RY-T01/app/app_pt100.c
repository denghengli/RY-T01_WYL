#include "includes.h"

#define TAB_MAXNUM    501   //分度表元素数量
#define TAB_SCALE     1     //分度表刻度
#define TAB_MINTEMP   0    //分度表最小温度
#define TAB_MAXTEMP   500   //分度表最大温度

/*温度 阻值分度表 ，刻度为1度*/
const float RTD_TAB_PT100[TAB_MAXNUM] =   
{
	100   , 100.39, 100.78,	101.17,	101.56,	101.95,	102.34,	102.73,	103.12,	103.51,   //0   ~ 9
	103.9 , 104.29, 104.68,	105.07,	105.46,	105.85,	106.24,	106.63,	107.02,	107.4 ,   //10  ~ 19
	107.79, 108.18,	108.57,	108.96,	109.35,	109.73,	110.12,	110.51,	110.9 , 111.29,   //20  ~ 29
	111.67, 112.06,	112.45,	112.83,	113.22,	113.61,	114   , 114.38,	114.77,	115.15,   //30  ~ 39
	115.54, 115.93,	116.31,	116.7 , 117.08,	117.47,	117.86,	118.24,	118.63,	119.01,   //40  ~ 49
	119.4 , 119.78,	120.17,	120.55,	120.94,	121.32,	121.71,	122.09,	122.47,	122.86,   //50  ~ 59
	123.24, 123.63,	124.01,	124.39,	124.78,	125.16,	125.54,	125.93,	126.31,	126.69,   //60  ~ 69
	127.08, 127.46,	127.84,	128.22,	128.61,	128.99,	129.37,	129.75,	130.13,	130.52,   //70  ~ 79
	130.9 , 131.28,	131.66,	132.04,	132.42,	132.8 , 133.18,	133.57,	133.95,	134.33,   //80  ~ 89
	134.71, 135.09,	135.47,	135.85,	136.23,	136.61,	136.99,	137.37,	137.75,	138.13,   //90  ~ 99
	138.51, 138.88,	139.26,	139.64,	140.02,	140.4 , 140.78,	141.16,	141.54,	141.91,   //100 ~ 109
	142.29, 142.67,	143.05,	143.43,	143.8 , 144.18,	144.56,	144.94,	145.31,	145.69,   //110 ~ 119
	146.07, 146.44,	146.82,	147.2 ,	147.57,	147.95,	148.33,	148.7 , 149.08,	149.46,   //120 ~ 129
	149.83, 150.21,	150.58,	150.96,	151.33,	151.71,	152.08,	152.46,	152.83,	153.21,   //130 ~ 139
	153.58, 153.96,	154.33,	154.71,	155.08,	155.46,	155.83,	156.2 , 156.58,	156.95,   //140 ~ 149
	157.33, 157.70, 158.07, 158.45, 158.82, 159.19, 159.56, 159.94, 160.31, 160.68,   //150 ~ 159
	161.05, 161.43, 161.80, 162.17, 162.54, 162.91, 163.29, 163.66, 164.03, 164.40,   //160 ~ 169
	164.77, 165.14, 165.51, 165.89, 166.26, 166.63, 167.00, 167.37, 167.74, 168.11,   //170 ~ 179
	168.48, 168.85, 169.22, 169.59, 169.96, 170.33, 170.70, 170.70, 171.43, 171.80,   //180 ~ 189  
	172.17, 172.54, 172.91, 173.28, 173.65, 174.02, 174.38, 174.75, 175.12, 175.49,   //190 ~ 199 
	175.86, 176.22, 176.59, 176.96, 177.33, 177.69, 178.06, 178.43, 178.79, 179.16,   //200 ~ 209 
	179.53, 179.89, 180.26, 180.63, 180.99, 181.36, 181.72, 182.09, 182.46, 182.82,   //210 ~ 219 
	183.19, 183.55, 183.92, 184.28, 184.65, 185.01, 185.38, 185.74, 186.11, 186.47,   //220 ~ 229 
	186.84, 187.20, 187.56, 187.93, 188.29, 188.66, 189.02, 189.38, 189.75, 190.11,   //230 ~ 239 
	190.47, 190.84, 191.20, 191.56, 191.92, 192.29, 192.65, 193.01, 193.37, 193.74,   //240 ~ 249 
	194.10, 194.46, 194.82, 195.18, 195.55, 195.91, 196.27, 196.63, 196.99, 197.35,   //250 ~ 259 
	197.71, 198.07, 198.43, 198.79, 199.15, 199.51, 199.87, 200.23, 200.59, 200.95,   //260 ~ 269 
	201.31, 201.67, 202.03, 202.39, 202.75, 203.11, 203.47, 203.83, 204.19, 204.55,   //270 ~ 279 
	204.90, 205.26, 205.62, 205.98, 206.34, 206.70, 207.05, 207.41, 207.77, 208.13,   //280 ~ 289 
    208.48, 208.84, 209.20, 209.56, 209.91, 210.27, 210.63, 210.98, 211.34, 211.70,   //290 ~ 299 
	212.05, 212.41, 212.76, 213.12, 213.48, 213.83, 214.19, 214.54, 214.90, 215.25,   //300 ~ 299 
	215.61, 215.96, 216.32, 216.67, 217.03, 217.38, 217.74, 218.09, 218.44, 218.80,   //310 ~ 319 
	219.15, 219.51, 219.86, 220.21, 220.57, 220.92, 221.27, 221.63, 221.98, 222.33,   //320 ~ 329 
	222.68, 223.04, 223.39, 223.74, 224.09, 224.45, 224.80, 225.15, 225.50, 225.85,   //330 ~ 339 
	226.21, 226.56, 226.91, 227.26, 227.61, 227.96, 228.31, 228.60, 229.02, 229.37,   //340 ~ 349 
	229.72, 230.07, 230.42, 230.77, 231.12, 231.47, 231.82, 232.17, 232.52, 232.87,   //350 ~ 359 
	233.21, 233.56, 233.91, 234.26, 234.61, 234.96, 235.31, 235.66, 236.00, 236.35,   //360 ~ 369 
	236.70, 237.05, 237.40, 237.74, 238.09, 238.44, 238.90, 239.13, 239.48, 239.83,   //370 ~ 379 
	240.18, 240.52, 240.87, 241.22, 241.56, 241.91, 242.26, 242.60, 242.95, 243.29,   //380 ~ 389 
	243.64, 243.99, 244.33, 244.68, 245.02, 245.37, 245.71, 246.06, 246.40, 246.75,   //390 ~ 399 
    247.09,	247.44,	247.78,	248.13,	248.47,	248.81,	249.16,	249.5,	245.85,	250.19,   //400 ~ 409 
    250.53,	250.88,	251.22,	251.56,	251.91,	252.25,	252.59,	252.93,	253.28,	253.62,   //410 ~ 419 
    253.96,	254.3,	254.65,	254.99,	255.33,	255.67,	256.01,	256.35,	256.7,	257.04,   //420 ~ 429 
    257.38,	257.72,	258.06,	258.4,	258.74,	259.08,	259.42,	259.76,	260.1,	260.44,   //430 ~ 439 
    260.78,	261.12,	261.46,	261.8,	262.14,	262.48,	262.82,	263.16,	263.5,	263.84,   //440 ~ 449 
    264.18,	264.52,	264.86,	265.2,	265.53,	265.87,	266.21,	266.55,	266.89,	267.22,   //450 ~ 459 
    267.56,	267.9,	268.24,	268.57,	268.91,	269.25,	269.59,	269.92,	270.26,	270.6 ,   //460 ~ 469 
    270.93,	271.27,	271.61,	271.94,	272.28,	272.61,	272.95,	273.29,	273.62,	273.96,   //470 ~ 479 
    274.29,	274.63,	274.96,	275.3,	275.63,	275.97,	276.3,	276.64,	276.97,	277.31,   //480 ~ 489 
    277.64,	277.98,	278.31,	278.64,	278.98,	279.31,	279.64,	279.98,	280.31,	280.64,   //490 ~ 499                                                                  
	280.98  //500
};		

float CalculateTemperature(float fR)
{
	float fTem = 0;
	float fLowRValue = 0;
	float fHighRValue = 0;        
	int   iTem,i,cBottom, cTop;

	
	if (fR < RTD_TAB_PT100[0])       // 低于量程下线
	{
		return -1;
	}

	if (fR > RTD_TAB_PT100[TAB_MAXNUM - 1])     //高于量程上线
	{
		return -1;
	}

	cBottom = 0; 
	cTop = TAB_MAXNUM - 1;

	for(i=TAB_MAXNUM/2; (cTop-cBottom)!=1; )    // 2分法查找
	{
		if (fR < RTD_TAB_PT100[i])
		{
			cTop = i;
			i = (cTop + cBottom) / 2;
		}
		else if (fR > RTD_TAB_PT100[i])
		{
			cBottom = i;
			i = (cTop + cBottom) / 2;
		}
		else
		{
			iTem = i * TAB_SCALE + TAB_MINTEMP;
			fTem = (float)iTem;

			return fTem;
		}
	}

	iTem = i * TAB_SCALE + TAB_MINTEMP;

	fLowRValue  = RTD_TAB_PT100[cBottom];
	fHighRValue = RTD_TAB_PT100[cTop];

	fTem = ( ((fR - fLowRValue)*TAB_SCALE) / (fHighRValue - fLowRValue) ) + iTem;  
																																				
	return fTem;
}


static PT100_DATA_T   s_tPT100Data;  /*PT100数据*/
static uint8_t  PT100_Ref_Flag;/*PT100参考值校准*/


/********************************************************************************************************
*	函 数 名: AtpPress_GetAD
*	功能说明: 获取PT100电压AD值
*	形    参: NONE
*	返 回 值: 温度系数
********************************************************************************************************/
static unsigned short PT100_GetAD()
{
	return g_ADCData.Aver[0];
}


/********************************************************************************************************
*	函 数 名: PT100_RefCal_Flag
*	功能说明: 开启温度参考值校准
*	形    参: NONE
*	返 回 值: 
********************************************************************************************************/
void PT100_RefCal_Flag(uint8_t flag)
{
	PT100_Ref_Flag = flag;
}


/********************************************************************************************************
*	函 数 名: PT100_TempMeasure
*	功能说明: 将ADS1247读取的电阻值换算成对应的温度
*	形    参: 温度
*	返 回 值: NONE
********************************************************************************************************/
void PT100_TempMeasure(void)
{
	char  i;
	static float fTempBuf[10] = {0.0};
	static uint8_t AvgCnt = 0;
	static uint8_t BufCnt = 0;
    float  fTemp = 0;
    
	s_tPT100Data.AD = PT100_GetAD();//读取PT100的电压AD值
	s_tPT100Data.Vol = (float)(3.0 / 4096.0) * s_tPT100Data.AD;//Pt100的电压值
    
//    fTemp = s_tPT100Data.Vol * 8.87 / 150 + 300.0 / 1100.0;
//    s_tPT100Data.ResVal = 1000 * fTemp / (3 - fTemp);

	fTemp = s_tPT100Data.Vol * 10 / 88.7 + 300.0 / 1100.0;
	s_tPT100Data.ResVal = 1000 * fTemp / (3 - fTemp);
	s_tPT100Data.Temp = CalculateTemperature(s_tPT100Data.ResVal);//根据电阻计算温度
	
	/*将数据存入环形buf中*/
	if(BufCnt <= 10)
	{
		if(BufCnt == 10)BufCnt = 0;
		if(AvgCnt < 10)AvgCnt++;
	}
	fTempBuf[BufCnt++] = s_tPT100Data.Temp;
    /*对环形buf中数据求和*/
	s_tPT100Data.Tempsum = 0.0;
	for(i=0;i<AvgCnt;i++)
	{
		s_tPT100Data.Tempsum   +=  fTempBuf[i];
	}
	/*计算环形buf中数据均值*/
	s_tPT100Data.Tempavg  = s_tPT100Data.Tempsum / (float)AvgCnt;
	
//	if(s_tPT100Data.Tempavg > 0.0001 || s_tPT100Data.Tempavg < -0.0001)//置位测量完成标志,非0时说明有测量值
//	{
		SetFlg_Measover(FLG_MEASOVER_TEMP);
//	}
    
    /* 把测量数据存入全局变量中 */
    FloatLimit(&s_tPT100Data.Tempavg, FLOAT_DECNUM);
    g_SysData.Data.Sample.ptTem = s_tPT100Data.Tempavg + g_SysData.Data.Para.ptTemRatioB;
	
	/*参考值校准*/
	if (PT100_Ref_Flag)
	{
		g_SysData.Data.Para.ptTemRatioB = g_SysData.Data.Para.ptTemRef - s_tPT100Data.Tempavg;
		PT100_Ref_Flag = 0;
		ParaData_Save(0);//将校准参数存入FLASH
	}
	
    SampleData_ToModbus();   
    
	LOG_PRINT(DEBUG_PT100,"T100.AD = %d  ",       s_tPT100Data.AD);
	LOG_PRINT(DEBUG_PT100,"T100.Vol = %f  ",      s_tPT100Data.Vol);
	LOG_PRINT(DEBUG_PT100,"T100.ResVal = %f ",    s_tPT100Data.ResVal);
	LOG_PRINT(DEBUG_PT100,"T100.Temp = %f ",      s_tPT100Data.Temp);
	LOG_PRINT(DEBUG_PT100,"T100.Tempavg = %f\r\n",s_tPT100Data.Tempavg);
}



/**********************************************************************************************************
*	函 数 名: APP_PT100
*	功能说明: APP_PT100 function
*	形    参: argument   数据指针
*	返 回 值: NONE
**********************************************************************************************************/
void APP_PT100(void  * argument)
{
    TickType_t sMaxBlockTime =	pdMS_TO_TICKS(200);
    
	while(1)
	{
        PT100_TempMeasure();
        
        LOG_PRINT(DEBUG_TASK,"APP_PT100 \r\n");
        vTaskDelay(sMaxBlockTime);
	}
}




